@{
    ViewBag.Title = "Messaging";
}
<div id="divSeparator"></div>
<div class="container">
    <div class="row">
        <div class="col-md-3" id="containerForUser">
            <table id="userContainer"></table>
        </div>
        <div class="col-md-5" id="colMessage">
            <div class="panel panel-default">
                <div class="panel-body">
                    <table id="messageContainer"></table>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-md-push-1">
            <div class="panel panel-default">
                <div class="panel-heading">
                    ads head
                </div>
                <div class="panel-body">
                    ads bdy
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    function getMessages() {
        userMessages = new wijmo.collections.ObservableArray;
        $.ajax({
            type: "GET",
            url: '/api/list/usermessages',
            contentType: "application/json;charset=utf-8",
            success: function (userMessageResult) {
                if (userMessageResult.length > 0) {
                    for (i = 0; i < userMessageResult.length; i++) {
                        var buttonEdit = document.createElement('a')
                        var buttonTextNode = document.createTextNode(userMessageResult[i]["SenderUser"]);
                        buttonEdit.appendChild(buttonTextNode);
                        buttonEdit.title = userMessageResult[i]["SenderUser"];
                        buttonEdit.className = "messaggeLink";
                        buttonEdit.href = '/SmartShop/Messaging?senderUserId=' + userMessageResult[i]["SenderUserId"];

                        userMessages.push({
                            SenderUserId: userMessageResult[i]["SenderUserId"],
                            SenderUser: buttonEdit,
                        });
                    }
                }

                $(function () {
                    $.each(userMessages, function (i, user) {
                        var classActive = "userClassDefault";
                        if (getUrlParameter("senderUserId") == user.SenderUserId) {
                            classActive = "useractive";
                        }
                        var $tr = $('<tr class="tr ' + classActive + '">').append(
                            $('<td class="td">').append(user.SenderUser)

                        ).appendTo('#userContainer');

                    });
                });


            }
        });
        return userMessages;
    }

    function messageBox() {
        messages = new wijmo.collections.ObservableArray;
        $.ajax({
            type: "GET",
            url: '/api/list/message/' + getUrlParameter("senderUserId"),
            contentType: "application/json;charset=utf-8",
            success: function (messageBox) {
                if (messageBox.length > 0) {
                    for (i = 0; i < messageBox.length; i++) {
                        messages.push({
                            SenderUserId: messageBox[i]["SenderUserId"],
                            SenderUser: messageBox[i]["SenderUser"],
                            RecipientUser: messageBox[i]["RecipientUser"],
                            MessageBody: messageBox[i]["MessageBody"],
                            MessageDate: messageBox[i]["MessageDate"],
                        });
                    }
                }

                $(function () {
                    $.each(messageBox, function (i, user) {
                        var classActive = "Receiver";
                        var textalign = "right";
                        if (getUrlParameter("senderUserId") == user.SenderUserId) {
                            classActive = "Sender";
                            textalign = "left";
                        }

                        var $tr = $('<tr class="messagetr' + classActive + '">').append(
                            $('<td class="messagetd" align="' + textalign + '">').text(user.MessageBody)
                        ).appendTo('#messageContainer');

                    });
                });


            }
        });
        return messages;
    }



    // get parameters in url
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.href);
        if (results == null) {
            return "";
        } else {
            return results[1];
        }
    }

    window.onload = function () {
        getMessages();
        messageBox();
    }
</script>
